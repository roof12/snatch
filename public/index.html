<!doctype html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8" />
    <title>Snatch</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      var attached = false;
      var attachDown = false;
      var attachedSprite = null;

      var angularVelocity = 250;
      var boundingBox = 50;

      function preload() {
        game.load.image('player', 'assets/ship.gif');
        game.load.image('thing', 'assets/thing.png');
      }

      function create() {
        game.physics.startSystem(Phaser.Physics.ARCADE);

        thing0 = game.add.sprite(345, 330, 'thing');
        thing0.anchor.setTo(0.5, 0.5);

        thing1 = game.add.sprite(385, 330, 'thing');
        thing1.anchor.setTo(0.5, 0.5);

        thing2 = game.add.sprite(425, 330, 'thing');
        thing2.anchor.setTo(0.5, 0.5);

        player = game.add.sprite(400, 300, 'player');
        player.anchor.setTo(0.5, 0.5);
        player.angle = -90;

        game.physics.arcade.enable(player, Phaser.Physics.ARCADE);

        attach = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
      }

      function update() {
        player.body.velocity.x = 0;
        player.body.velocity.y = 0;
        player.body.angularVelocity = 0;

        if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT)) {
          player.body.angularVelocity = -angularVelocity;
        } else if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT)) {
          player.body.angularVelocity = angularVelocity;
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.UP)) {
          game.physics.arcade.velocityFromAngle(player.angle, 300, player.body.velocity);
        }

        if (attach.isDown && !attachDown) {
          attachDown = true;
        }
        if (attach.isUp && attachDown) {
          attachDown = false;
          if (attachedSprite) {
            detachSprite();
          } else {
            attachIfNear(thing0);
            attachIfNear(thing1);
            attachIfNear(thing2);
          }
        }

        if (attachedSprite) {
          attachedSprite.x = player.x;
          attachedSprite.y = player.y;       
        }
      }

      function attachIfNear(sprite) {
        if (attachedSprite === null && near(player, sprite)) {
          attachSprite(sprite);
        }
      }

      function near(sprite0, sprite1) {
        var dx = Math.abs(sprite0.x - sprite1.x);
        var dy = Math.abs(sprite0.y - sprite1.y);
        console.log("dx: " + dx + " dy: " + dy);
        return (dx < boundingBox) && (dy < boundingBox);
      }

      function detachSprite() {
        attachedSprite = null;
      }

      function attachSprite(sprite) {
        attachedSprite = sprite;
      }
    </script>
  </body>
</html>
